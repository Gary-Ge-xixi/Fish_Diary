<view class="page-container">
  <!-- å¯¼èˆªæ  -->
  <navigation-bar title="ç™¾ç§‘" back="{{false}}" color="black" background="#fff"></navigation-bar>

  <view class="content-wrapper">
    <!-- æœç´¢æ  -->
    <view class="search-bar">
      <view class="search-input-wrapper">
        <text class="search-icon">ğŸ”</text>
        <input
          class="search-input"
          placeholder="æœç´¢é±¼åã€å­¦å..."
          bindinput="onSearchInput"
          bindconfirm="onSearchConfirm"
          value="{{searchQuery}}"
          placeholder-class="input-placeholder"
          confirm-type="search"
        />
      </view>
    </view>

    <!-- åˆ†ç±»ç­›é€‰ -->
    <scroll-view scroll-x class="category-scroll" enhanced show-scrollbar="{{false}}">
      <view class="category-list">
        <view
          wx:for="{{categories}}"
          wx:key="_id"
          class="category-chip {{activeCategory === item._id ? 'category-chip--active' : ''}}"
          data-id="{{item._id}}"
          bindtap="onCategorySelect"
        >
          {{item.name}}
        </view>
      </view>
    </scroll-view>

    <!-- åŠ è½½çŠ¶æ€ - éª¨æ¶å± -->
    <view class="wiki-list" style="padding: var(--spacing-md);" wx:if="{{loading && filteredList.length === 0}}">
      <view class="skeleton-card" wx:for="{{[1,2,3,4]}}" wx:key="*this">
        <view class="skeleton-image"></view>
        <view class="skeleton-content">
          <view class="skeleton-line short"></view>
          <view class="skeleton-line medium"></view>
          <view class="skeleton-line"></view>
        </view>
      </view>
    </view>

    <!-- é±¼ç±»åˆ—è¡¨ -->
    <scroll-view
      scroll-y
      class="wiki-scroll"
      enhanced
      show-scrollbar="{{false}}"
      bindscrolltolower="onReachBottom"
      wx:if="{{!loading || filteredList.length > 0}}"
    >
      <view class="wiki-list" wx:if="{{filteredList.length > 0}}">
        <view
          class="wiki-card"
          wx:for="{{filteredList}}"
          wx:key="_id"
          data-id="{{item._id}}"
          bindtap="onFishClick"
        >
          <!-- å›¾ç‰‡ 1:1 -->
          <view class="wiki-image-wrapper">
            <image wx:if="{{item.imageUrl}}" src="{{item.imageUrl}}" mode="aspectFill" class="wiki-image"></image>
            <text wx:else class="wiki-emoji">ğŸŸ</text>
          </view>
          
          <view class="wiki-info">
             <view class="flex justify-between items-center mb-xs">
                 <text class="wiki-name">{{item.name}}</text>
                 <view class="difficulty-badge {{item.difficulty || 'easy'}}">
                     {{item.difficulty === 'easy' ? 'ç®€å•' : item.difficulty === 'medium' ? 'ä¸­ç­‰' : item.difficulty === 'hard' ? 'å›°éš¾' : 'ç®€å•'}}
                 </view>
             </view>
             
             <view class="wiki-row">
                <text class="wiki-label">ä¹ æ€§</text>
                <text class="wiki-value">{{item.habitDisplay}}</text>
             </view>
             <view class="wiki-row">
                <text class="wiki-label">é¥²å…»</text>
                <text class="wiki-value">{{item.methodDisplay}}</text>
             </view>
          </view>
        </view>
      </view>

      <view class="empty-state" wx:if="{{!loading && filteredList.length === 0}}">
        <text class="text-muted">æœªæ‰¾åˆ°ç›¸å…³é±¼ç±»</text>
      </view>

      <!-- åŠ è½½æ›´å¤š -->
      <view class="load-more" wx:if="{{filteredList.length > 0 && hasMore}}">
        <text class="text-muted text-sm">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
      </view>
      <view class="load-more" wx:if="{{filteredList.length > 0 && !hasMore}}">
        <text class="text-muted text-sm">å·²åŠ è½½å…¨éƒ¨</text>
      </view>

      <!-- åº•éƒ¨å®‰å…¨åŒº -->
      <view class="safe-area-bottom"></view>
    </scroll-view>
  </view>
</view>

<!-- è¯¦æƒ…å¼¹çª—ï¼ˆåœ¨ page-container å¤–éƒ¨ï¼Œå¯æ­£ç¡®è¦†ç›– tabbarï¼‰ -->
<view wx:if="{{showDetailPopup}}" class="popup-mask" bindtap="onCloseDetail">
    <view class="popup popup--bottom" catchtap="stopPropagation" wx:if="{{currentFish}}">
      <view class="popup__header">
        <text class="popup__close" bindtap="onCloseDetail">Ã—</text>
        <text class="popup__title">é±¼ç±»æ¡£æ¡ˆ</text>
        <view class="popup__placeholder"></view>
      </view>

      <scroll-view class="popup__body" scroll-y enhanced show-scrollbar="{{false}}">
         <!-- ç¬¬ä¸€å±‚ï¼šåŸºç¡€ä¿¡æ¯å¤´éƒ¨ -->
         <view class="detail-header">
            <view class="detail-avatar">
              <image wx:if="{{currentFish.imageUrl}}" src="{{currentFish.imageUrl}}" mode="aspectFill" class="detail-avatar-image"></image>
              <text wx:else>ğŸŸ</text>
            </view>
            <view class="detail-titles">
               <text class="detail-name">{{currentFish.name}}</text>
               <text class="detail-eng">{{currentFish.englishName || '-'}}</text>
               <text class="detail-sci">{{currentFish.scientificName || '-'}}</text>
            </view>
         </view>

         <!-- ç¬¬äºŒå±‚ï¼šå…»æ®–å¯è¡Œæ€§å‚æ•° -->
         <view class="detail-section">
            <view class="detail-grid">
               <view class="grid-item">
                  <text class="grid-label">é¥²å…»éš¾åº¦</text>
                  <text class="grid-value">{{currentFish.difficulty === 'easy' ? 'ç®€å•' : currentFish.difficulty === 'medium' ? 'ä¸­ç­‰' : currentFish.difficulty === 'hard' ? 'å›°éš¾' : '-'}}</text>
               </view>
               <view class="grid-item">
                  <text class="grid-label">æ¸©åº¦</text>
                  <text class="grid-value" wx:if="{{currentFish.tempMin != null && currentFish.tempMax != null}}">{{currentFish.tempMin}}-{{currentFish.tempMax}}Â°C</text>
                  <text class="grid-value" wx:else>-</text>
               </view>
               <view class="grid-item">
                  <text class="grid-label">pH</text>
                  <text class="grid-value" wx:if="{{currentFish.phMin != null && currentFish.phMax != null}}">{{currentFish.phMin}}-{{currentFish.phMax}}</text>
                  <text class="grid-value" wx:else>-</text>
               </view>
               <view class="grid-item">
                  <text class="grid-label">ä½“é•¿</text>
                  <text class="grid-value" wx:if="{{currentFish.bodyLengthMin != null && currentFish.bodyLengthMax != null}}">{{currentFish.bodyLengthMin}}-{{currentFish.bodyLengthMax}}cm</text>
                  <text class="grid-value" wx:else>-</text>
               </view>
               <view class="grid-item" wx:if="{{currentFish.lifespan}}">
                  <text class="grid-label">å¯¿å‘½</text>
                  <text class="grid-value">{{currentFish.lifespan}}å¹´</text>
               </view>
               <view class="grid-item" wx:if="{{currentFish.origin}}">
                  <text class="grid-label">äº§åœ°</text>
                  <text class="grid-value">{{currentFish.origin}}</text>
               </view>
            </view>
         </view>

         <!-- ç¬¬ä¸‰å±‚ï¼šæ·±å…¥äº†è§£ - ç®€ä»‹ -->
         <view class="detail-section" wx:if="{{currentFish.description}}">
            <text class="section-title">ç®€ä»‹</text>
            <text class="section-text">{{currentFish.description}}</text>
         </view>

         <!-- é¥²å…»æŠ€å·§ï¼ˆé«˜äº®æç¤ºæ¡†ï¼‰ -->
         <view class="detail-section care-tip-box" wx:if="{{currentFish.careTip}}">
            <view class="care-tip-header">
               <text class="care-tip-icon">ğŸ’¡</text>
               <text class="care-tip-title">é¥²å…»æŠ€å·§</text>
            </view>
            <text class="care-tip-text">{{currentFish.careTip}}</text>
         </view>

         <!-- ä¹ æ€§ä¿¡æ¯ -->
         <view class="detail-section">
            <text class="section-title">ä¹ æ€§</text>
            <view class="info-row">
               <text class="info-label">æ€§æ ¼ï¼š</text>
               <text class="info-value">{{currentFish.temperament === 'peaceful' ? 'æ¸©å’Œ' : currentFish.temperament === 'semi-aggressive' ? 'åŠæ”»å‡»æ€§' : currentFish.temperament === 'aggressive' ? 'æ”»å‡»æ€§' : '-'}}</text>
            </view>
            <view class="info-row" wx:if="{{currentFish.diet}}">
               <text class="info-label">é£Ÿæ€§ï¼š</text>
               <text class="info-value">{{currentFish.diet}}</text>
            </view>
            <view class="info-row" wx:if="{{currentFish.compatibility}}">
               <text class="info-label">æ··å…»ï¼š</text>
               <text class="info-value">{{currentFish.compatibility}}</text>
            </view>
            <view class="info-row" wx:if="{{currentFish.category}}">
               <text class="info-label">åˆ†ç±»ï¼š</text>
               <text class="info-value">{{currentFish.category.name}}{{currentFish.subcategory ? ' / ' + currentFish.subcategory.name : ''}}</text>
            </view>
         </view>

         <!-- ç¬¬å››å±‚ï¼šè¿›é˜¶ä¿¡æ¯ - ç¯å¢ƒè¦æ±‚ -->
         <view class="detail-section" wx:if="{{currentFish.environment}}">
            <text class="section-title">ç¯å¢ƒè¦æ±‚</text>
            <text class="section-text">{{currentFish.environment}}</text>
         </view>

         <!-- é¥²å…»ç‰¹ç‚¹ -->
         <view class="detail-section" wx:if="{{currentFish.husbandryFeatures}}">
            <text class="section-title">é¥²å…»ç‰¹ç‚¹</text>
            <text class="section-text">{{currentFish.husbandryFeatures}}</text>
         </view>

         <!-- æ³¨æ„äº‹é¡¹ï¼ˆè­¦å‘Šæç¤ºæ¡†ï¼‰ -->
         <view class="detail-section notes-box" wx:if="{{currentFish.notes}}">
            <view class="notes-header">
               <text class="notes-icon">âš ï¸</text>
               <text class="notes-title">æ³¨æ„äº‹é¡¹</text>
            </view>
            <text class="notes-text">{{currentFish.notes}}</text>
         </view>

         <!-- åº•éƒ¨å®‰å…¨åŒº -->
         <view style="height: 40rpx;"></view>
      </scroll-view>
    </view>
  </view>
