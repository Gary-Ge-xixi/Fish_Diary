<!--index.wxml - shadcn/ui æç®€é£æ ¼-->
<view class="page-container">
  <view class="nav-wrapper" style="height: 91px; overflow: hidden; background: #fff;">
    <navigation-bar back="{{false}}" color="black" background="#fff">
      <view slot="left" style="padding-left: 12px; font-weight: 600; font-size: 18px; display: flex; align-items: center; height: 100%; white-space: nowrap;">
        Fish Diary
      </view>
    </navigation-bar>
  </view>

  <scroll-view class="page-scroll" scroll-y type="list" enhanced show-scrollbar="{{false}}">
    <!-- åŠ è½½çŠ¶æ€ - éª¨æ¶å± -->
    <block wx:if="{{loading}}">
      <!-- é±¼ç¼¸é€‰æ‹©å™¨éª¨æ¶å± -->
      <view class="section">
        <view class="section-header">
          <text class="section-title">æˆ‘çš„é±¼ç¼¸</text>
        </view>
        <scroll-view scroll-x class="tank-scroll" enhanced show-scrollbar="{{false}}">
          <view class="skeleton-tank-list">
            <view class="skeleton-tank-item" wx:for="{{[1,2,3]}}" wx:key="*this">
              <view class="skeleton-tank-cover"></view>
              <view class="skeleton-tank-name"></view>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- ç»Ÿè®¡å¡ç‰‡éª¨æ¶å± -->
      <view class="section">
        <view class="card">
          <view class="card__header">
            <view class="skeleton-line short"></view>
          </view>
          <view class="card__body">
            <view class="skeleton-stats-grid">
              <view class="skeleton-stat-item" wx:for="{{[1,2,3,4]}}" wx:key="*this">
                <view class="skeleton-stat-value"></view>
                <view class="skeleton-stat-label"></view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- è®°å½•åˆ—è¡¨éª¨æ¶å± -->
      <view class="section">
        <view class="section-header">
          <text class="section-title">ç®¡ç†</text>
        </view>
        <view class="skeleton-list" style="margin-top: var(--spacing-md);">
          <view class="skeleton-card" wx:for="{{[1,2,3]}}" wx:key="*this">
            <view class="skeleton-avatar"></view>
            <view class="skeleton-content">
              <view class="skeleton-line short"></view>
              <view class="skeleton-line medium"></view>
              <view class="skeleton-line"></view>
            </view>
          </view>
        </view>
      </view>
    </block>

    <!-- ç©ºçŠ¶æ€ -->
    <block wx:elif="{{!loading && tanks.length === 0}}">
      <view class="empty-container">
        <view class="empty-state">
          <text class="empty-state__icon">ğŸ </text>
          <text class="empty-state__title">è¿˜æ²¡æœ‰é±¼ç¼¸</text>
          <text class="empty-state__desc">æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªé±¼ç¼¸ï¼Œå¼€å§‹è®°å½•å…»é±¼ç”Ÿæ´»</text>
          <button class="btn btn--primary" bindtap="onAddTank">æ·»åŠ é±¼ç¼¸</button>
        </view>
      </view>
    </block>

    <!-- ä¸»å†…å®¹ -->
    <block wx:else>
      <!-- é±¼ç¼¸é€‰æ‹©å™¨ -->
      <view class="section">
        <view class="section-header">
          <text class="section-title">æˆ‘çš„é±¼ç¼¸</text>
          <!-- é±¼ç±»ç™¾ç§‘å…¥å£æš‚æ—¶éšè— -->
          <!-- <view class="flex items-center gap-sm" bindtap="onOpenWiki">
             <text class="text-sm" style="color: #3b82f6;">ğŸ“˜ é±¼ç±»ç™¾ç§‘</text>
          </view> -->
        </view>

        <scroll-view scroll-x class="tank-scroll" enhanced show-scrollbar="{{false}}">
          <view class="tank-list">
            <view
              wx:for="{{tanks}}"
              wx:key="_id"
              class="tank-item {{currentTankIndex === index ? 'tank-item--active' : ''}}"
              data-index="{{index}}"
              bindtap="onTankSelect"
            >
              <image
                class="tank-item__cover"
                src="{{item.coverUrl || '/assets/images/default-tank.png'}}"
                mode="aspectFill"
              ></image>
              <text class="tank-item__name">{{item.name}}</text>
            </view>

            <view wx:if="{{tanks.length < 10}}" class="tank-item tank-item--add" bindtap="onAddTank">
              <view class="tank-item__add-icon">+</view>
              <text class="tank-item__name text-muted">æ·»åŠ </text>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <view class="section" wx:if="{{currentTank}}">
        <view class="card" bindtap="onTankDetail">
          <view class="card__header">
            <view class="flex items-center justify-between">
              <text class="card__title">{{currentTank.name}}</text>
              <view class="flex items-center gap-sm">
                <text class="text-muted">æŸ¥çœ‹è¯¦æƒ…</text>
                <image class="arrow-icon" src="/assets/icons/chevron-right.svg" mode="aspectFit" />
              </view>
            </view>
          </view>
          <view class="card__body">
            <view wx:if="{{tankStats}}" class="stats-grid">
              <view class="stat-item">
                <text class="stat-value {{tankStats.fish.survivalRate >= 80 ? 'text-success' : tankStats.fish.survivalRate >= 50 ? 'text-warning' : 'text-danger'}}">{{tankStats.fish.survivalRate || 0}}%</text>
                <text class="stat-label">å­˜æ´»ç‡</text>
              </view>
              <view class="stat-item">
                <text class="stat-value">{{tankStats.fish.aliveSpeciesCount || 0}}</text>
                <text class="stat-label">é±¼ç§</text>
              </view>
              <view class="stat-item">
                <text class="stat-value">Â¥{{tankStats.totalInvestment || 0}}</text>
                <text class="stat-label">æ€»æŠ•èµ„</text>
              </view>
              <view class="stat-item">
                <text class="stat-value text-danger">Â¥{{tankStats.fish.deadTotalPrice || 0}}</text>
                <text class="stat-label">æŸå¤±</text>
              </view>
            </view>
            <view wx:else class="stats-loading">
              <text class="text-muted text-sm">åŠ è½½ç»Ÿè®¡æ•°æ®...</text>
            </view>
          </view>
        </view>
      </view>

      <!-- åŠŸèƒ½åŒºåŸŸ -->
      <view class="section">
        <view class="section-header">
          <text class="section-title">ç®¡ç†</text>
        </view>

        <view class="tabs">
          <view
            wx:for="{{tabs}}"
            wx:key="key"
            class="tab-item {{activeTab === item.key ? 'tab-item--active' : ''}}"
            data-key="{{item.key}}"
            bindtap="onTabChange"
          >
            <text>{{item.name}}</text>
          </view>
        </view>

        <view class="tab-content">
          <view wx:if="{{activeTab === 'records'}}" class="tab-panel">
             <!-- æ—¥æœŸç­›é€‰ -->
             <view class="record-filter">
                <view class="filter-row">
                   <picker mode="date" value="{{recordFilterDate}}" end="{{today}}" bindchange="onRecordFilterDateChange">
                      <view class="date-picker-trigger">
                         <text class="date-text">{{recordFilterDate === today ? 'ä»Šæ—¥' : recordFilterDate}}</text>
                         <text class="date-icon">â–¼</text>
                      </view>
                   </picker>
                   <view class="filter-clear" wx:if="{{recordFilterDate && recordFilterDate !== today}}" bindtap="onClearRecordFilter">
                      <text>è¿”å›ä»Šæ—¥</text>
                   </view>
                </view>
             </view>

             <!-- è®°å½•åˆ—è¡¨ - ç»Ÿä¸€æ ·å¼ -->
             <view class="record-list-unified" wx:if="{{recordList.length > 0}}">
                <view class="record-card" wx:for="{{recordList}}" wx:key="_id">
                   <!-- å¤´åƒ/å›¾æ ‡åŒºåŸŸ -->
                   <view class="record-avatar" style="background: {{item.type === 'feeding' ? '#fef3c7' : item.type === 'water-change' ? '#cffafe' : '#dbeafe'}};">
                      <text wx:if="{{item.type === 'feeding'}}">ğŸ–</text>
                      <text wx:elif="{{item.type === 'water-change'}}">ğŸ’§</text>
                      <text wx:else>ğŸ§ª</text>
                   </view>

                   <!-- å†…å®¹åŒºåŸŸ -->
                   <view class="record-info">
                      <!-- æ ‡é¢˜è¡Œ -->
                      <view class="record-info-header">
                         <text class="record-name">{{item.type === 'feeding' ? 'å–‚å…»è®°å½•' : item.type === 'water-change' ? 'æ¢æ°´è®°å½•' : 'æ°´è´¨è®°å½•'}}</text>
                         <image class="arrow-icon" src="/assets/icons/chevron-right.svg" mode="aspectFit" />
                      </view>

                      <!-- å–‚å…»è¯¦æƒ… -->
                      <block wx:if="{{item.type === 'feeding'}}">
                         <view class="record-meta">
                            <view class="meta-row">
                               <text class="meta-label">é£Ÿç‰©</text>
                               <text class="meta-value">{{item.foodTypeName}}</text>
                               <view class="meta-divider" wx:if="{{item.foodName}}"></view>
                               <text class="meta-value" wx:if="{{item.foodName}}">{{item.foodName}}</text>
                            </view>
                            <text class="record-time">{{item.date}} {{item.time}}</text>
                         </view>
                      </block>

                      <!-- æ¢æ°´è¯¦æƒ… -->
                      <block wx:elif="{{item.type === 'water-change'}}">
                         <view class="record-meta">
                            <view class="meta-row">
                               <text class="meta-label">æ¢æ°´é‡</text>
                               <text class="meta-value" style="color: #0891b2; font-weight: 600;">{{item.percent}}%</text>
                            </view>
                            <text class="record-time">{{item.date}} {{item.time}}</text>
                         </view>
                      </block>

                      <!-- æ°´è´¨è¯¦æƒ… - æ¨ªå‘æ»šåŠ¨ -->
                      <block wx:elif="{{item.type === 'water-quality'}}">
                         <scroll-view scroll-x class="quality-data-scroll" enhanced show-scrollbar="{{false}}">
                            <view class="quality-data-row">
                               <view class="quality-tag" wx:if="{{item.ph}}">
                                  <text class="quality-tag-label">pH</text>
                                  <text class="quality-tag-value">{{item.ph}}</text>
                               </view>
                               <view class="quality-tag" wx:if="{{item.temperature}}">
                                  <text class="quality-tag-label">æ¸©åº¦</text>
                                  <text class="quality-tag-value">{{item.temperature}}Â°C</text>
                               </view>
                               <view class="quality-tag" wx:if="{{item.ammonia !== undefined && item.ammonia !== null}}">
                                  <text class="quality-tag-label">æ°¨æ°®</text>
                                  <text class="quality-tag-value {{item.ammonia > 0 ? 'text-danger' : ''}}">{{item.ammonia}}</text>
                               </view>
                               <view class="quality-tag" wx:if="{{item.nitrite !== undefined && item.nitrite !== null}}">
                                  <text class="quality-tag-label">NO2</text>
                                  <text class="quality-tag-value {{item.nitrite > 0 ? 'text-danger' : ''}}">{{item.nitrite}}</text>
                               </view>
                               <view class="quality-tag" wx:if="{{item.nitrate !== undefined && item.nitrate !== null}}">
                                  <text class="quality-tag-label">NO3</text>
                                  <text class="quality-tag-value {{item.nitrate > 40 ? 'text-warning' : ''}}">{{item.nitrate}}</text>
                               </view>
                            </view>
                         </scroll-view>
                         <text class="record-time">{{item.date}} {{item.time}}</text>
                      </block>
                   </view>
                </view>
             </view>

             <view class="empty-panel" wx:elif="{{!loading}}">
                <text class="text-muted">æš‚æ— è®°å½•</text>
             </view>

             <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’®ï¼šä»…ä»Šæ—¥æ˜¾ç¤º -->
             <view wx:if="{{tanks.length > 0 && recordFilterDate === today}}" class="add-feeding-btn floating-add-btn" bindtap="onAddRecord">
                  <text class="add-icon">+</text>
                  <text>è®°å½•</text>
             </view>
          </view>
          <view wx:elif="{{activeTab === 'fish'}}" class="tab-panel">
            <view class="fish-list" wx:if="{{fishList.length > 0}}">
              <!-- é±¼ç±»åˆ—è¡¨ï¼ˆAPI å·²æŒ‰ tankId è¿‡æ»¤ï¼‰ -->
              <view class="fish-item" wx:for="{{fishList}}" wx:key="_id" bindtap="onFishClick" data-id="{{item._id}}">
                  <view class="fish-avatar">
                     <image wx:if="{{item.imageUrl}}" src="{{item.imageUrl}}" mode="aspectFill" class="fish-avatar-image"></image>
                     <text wx:else style="font-size: 44rpx;">ğŸŸ</text>
                  </view>
                  <view class="fish-info">
                    <view class="fish-header">
                      <text class="fish-name">{{item.customName}}</text>
                      <image class="arrow-icon" src="/assets/icons/chevron-right.svg" mode="aspectFit" />
                    </view>
                    <view class="fish-meta">
                      <view class="meta-row">
                        <text class="meta-label">æ•°é‡</text>
                        <text class="meta-value">{{item.quantity}}</text>
                        <view class="meta-divider"></view>
                        <text class="meta-label">æ€»ä»·</text>
                        <text class="meta-value price">Â¥{{item.totalPriceDisplay}}</text>
                      </view>
                      <text class="fish-date">{{item.purchaseDateDisplay}}</text>
                    </view>
                  </view>
                </view>
            </view>
            <view class="empty-panel" wx:else>
              <text class="text-muted">æš‚æ— é±¼ç±»æ•°æ®</text>
            </view>
            <view wx:if="{{tanks.length > 0}}" class="add-feeding-btn floating-add-btn" bindtap="onAddFish">
                  <text class="add-icon">+</text>
                  <text>æ·»åŠ é±¼ç±»</text>
              </view>
          </view>



          <view wx:elif="{{activeTab === 'equipment'}}" class="tab-panel">
            <view class="equipment-list" wx:if="{{equipmentList.length > 0}}">
               <view class="equipment-card" wx:for="{{equipmentList}}" wx:key="_id">
                  <view class="eq-header">
                     <view class="eq-type-badge">{{item.typeName}}</view>
                     <text class="eq-price">Â¥{{item.price}}</text>
                  </view>
                  <view class="eq-body">
                     <text class="eq-name">{{item.name}}</text>
                     <text class="eq-meta">{{item.brand}} {{item.model}}</text>
                  </view>
               </view>
            </view>
            <view class="empty-panel" wx:elif="{{!equipmentLoading}}">
              <text class="text-muted">æš‚æ— è®¾å¤‡æ•°æ®</text>
            </view>

             <view wx:if="{{tanks.length > 0}}" class="add-feeding-btn floating-add-btn" bindtap="onAddEquipment">
                  <text class="add-icon">+</text>
                  <text>æ·»åŠ è®¾å¤‡</text>
              </view>
          </view>
        </view>
      </view>

      <view class="safe-area-bottom"></view>
    </block>
  </scroll-view>
</view>

<!-- ========== å¼¹çª—åŒºåŸŸï¼ˆåœ¨ page-container å¤–éƒ¨ï¼Œå¯æ­£ç¡®è¦†ç›– tabbarï¼‰ ========== -->

<!-- ========== æ·»åŠ å–‚é£Ÿå¼¹çª— ========== -->
  <view wx:if="{{showFeedingPopup}}" class="popup-mask" bindtap="onCloseFeedingPopup">
    <view class="popup popup--bottom" catchtap="stopPropagation">
      <view class="popup__header">
        <text class="popup__close" bindtap="onCloseFeedingPopup">Ã—</text>
        <text class="popup__title">æ·»åŠ å–‚é£Ÿè®°å½•</text>
        <view class="popup__placeholder"></view>
      </view>

      <scroll-view class="popup__body" scroll-y enhanced show-scrollbar="{{false}}">
        <view class="form-wrapper">
          <!-- æ—¶é—´é€‰æ‹© -->
          <view class="form-item">
            <text class="form-label">å–‚é£Ÿæ—¶é—´</text>
            <picker mode="time" value="{{feedingForm.time}}" bindchange="onFeedingTimeChange">
              <view class="input-picker">
                <text>{{feedingForm.time}}</text>
                <text class="text-muted">></text>
              </view>
            </picker>
          </view>

          <!-- é£Ÿç‰©ç±»å‹ -->
          <view class="form-item">
            <text class="form-label">é£Ÿç‰©ç±»å‹</text>
            <view class="chip-group">
              <view 
                wx:for="{{foodTypeOptions}}" 
                wx:key="key"
                class="chip {{feedingForm.foodType === item.key ? 'chip--active' : ''}}"
                data-type="{{item.key}}"
                bindtap="onSelectFoodType"
              >
                {{item.label}}
              </view>
            </view>
          </view>
          
          <!-- å›¾ç‰‡ä¸Šä¼  -->
          <view class="form-item">
            <text class="form-label">æ‹ç…§è®°å½• (é€‰å¡«)</text>
            <view class="image-picker" bindtap="onChooseFeedingImage">
              <image wx:if="{{feedingForm.imageUrl}}" src="{{feedingForm.imageUrl}}" mode="aspectFill" class="image-picker__preview"></image>
              <view wx:else class="image-picker__placeholder">
                <text class="image-picker__icon">+</text>
              </view>
            </view>
          </view>

          <!-- å…¶ä»–é£Ÿç‰©åç§°è¾“å…¥ -->
          <view class="form-item" wx:if="{{feedingForm.foodType === 'other'}}">
            <text class="form-label">é£Ÿç‰©åç§° <text class="required">*</text></text>
            <input class="input" placeholder="è¯·è¾“å…¥é£Ÿç‰©åç§°" value="{{feedingForm.customFood}}" bindinput="onCustomFoodInput"></input>
          </view>
          
           <!-- å“ç‰Œ/å¤‡æ³¨ -->
          <view class="form-item" wx:else>
            <text class="form-label">å“ç‰Œ/å¤‡æ³¨ (é€‰å¡«)</text>
            <input class="input" placeholder="ä¾‹å¦‚ï¼šå¾·å½©ã€æµ·ä¸°" value="{{feedingForm.foodName}}" bindinput="onFoodNameInput"></input>
          </view>

        </view>
      </scroll-view>

      <view class="popup__footer">
        <button class="btn btn--primary btn--block" bindtap="onSaveFeeding" loading="{{saving}}">ä¿å­˜è®°å½•</button>
      </view>
    </view>
  </view>

  <!-- ========== æ·»åŠ é±¼ç¼¸å¼¹çª— ========== -->
  <page-container 
    show="{{showAddTankPopup}}" 
    round 
    position="bottom" 
    custom-style="background-color: var(--background);"
    bind:afterleave="onCloseAddTank"
  >
    <view class="popup-content">
      <!-- å¤´éƒ¨ -->
      <view class="popup__header">
        <text class="popup__close" bindtap="onCloseAddTank">Ã—</text>
        <text class="popup__title">æ·»åŠ é±¼ç¼¸</text>
        <view class="popup__placeholder"></view>
      </view>

      <!-- è¡¨å•å†…å®¹ -->
      <scroll-view class="popup__body" scroll-y enhanced show-scrollbar="{{false}}" style="max-height: 70vh;">
        <view class="form-wrapper">
          <!-- å›¾ç‰‡é€‰æ‹© -->
          <view class="form-item">
            <text class="form-label">é±¼ç¼¸å›¾ç‰‡ <text class="required">*</text></text>
            <text wx:if="{{errors.coverUrl}}" class="form-error">è¯·é€‰æ‹©å›¾ç‰‡</text>
            <view class="image-picker" bindtap="onChooseTankImage">
              <image wx:if="{{tankForm.coverUrl}}" src="{{tankForm.coverUrl}}" mode="aspectFill" class="image-picker__preview"></image>
              <view wx:else class="image-picker__placeholder">
                <text class="image-picker__icon">+</text>
                <text class="image-picker__text">æ‹ç…§/ç›¸å†Œ</text>
              </view>
            </view>
          </view>

          <!-- é±¼ç¼¸åç§° -->
          <view class="form-item">
            <text class="form-label">é±¼ç¼¸åç§° <text class="required">*</text></text>
            <text wx:if="{{errors.name}}" class="form-error">è¯·å¡«å†™é±¼ç¼¸åç§°</text>
            <input class="input" placeholder="è¯·è¾“å…¥åç§°ï¼ˆ20å­—ä»¥å†…ï¼‰" maxlength="20" value="{{tankForm.name}}" bindinput="onTankNameInput"></input>
          </view>

          <!-- é±¼ç¼¸å°ºå¯¸ -->
          <view class="form-item">
            <text class="form-label">é±¼ç¼¸å°ºå¯¸ <text class="required">*</text></text>
            <text wx:if="{{errors.sizeKey}}" class="form-error">è¯·é€‰æ‹©é±¼ç¼¸å°ºå¯¸</text>
            <view class="size-options">
              <view
                wx:for="{{tankSizeOptions}}"
                wx:key="key"
                class="size-option {{tankForm.sizeKey === item.key ? 'size-option--active' : ''}}"
                data-key="{{item.key}}"
                bindtap="onSelectTankSize"
              >
                <text class="size-option__label">{{item.label}}</text>
                <text class="size-option__desc">{{item.desc}}</text>
              </view>
            </view>
          </view>
          
          <!-- é±¼ç¼¸ä»·æ ¼ -->
          <view class="form-item">
            <text class="form-label">è´­ä¹°ä»·æ ¼ (Â¥)</text>
            <input class="input" type="digit" placeholder="0.00" value="{{tankForm.price}}" bindinput="onTankPriceInput"></input>
          </view>

        </view>
      </scroll-view>

      <!-- åº•éƒ¨æŒ‰é’® -->
      <view class="popup__footer">
        <button class="btn btn--primary btn--block" bindtap="onSaveTank" loading="{{saving}}">ä¿å­˜</button>
      </view>
    </view>
  </page-container>

  <!-- æ·»åŠ é±¼ç±»å¼¹çª— -->
  <view wx:if="{{showFishPopup}}" class="popup-mask" bindtap="onCloseFishPopup">
    <view class="popup popup--bottom" catchtap="stopPropagation">
      <view class="popup__header">
        <text class="popup__close" bindtap="onCloseFishPopup">Ã—</text>
        <text class="popup__title">æ·»åŠ é±¼ç±»</text>
        <view class="popup__placeholder"></view>
      </view>

      <scroll-view class="popup__body" scroll-y enhanced show-scrollbar="{{false}}">
        <view class="form-wrapper">
          <!-- å½“å‰é±¼ç¼¸ä¿¡æ¯ -->
          <!-- å½“å‰é±¼ç¼¸ä¿¡æ¯ -->
          <view class="form-item" wx:if="{{currentTank}}">
            <text class="form-label" style="margin-bottom: 12rpx;">æ·»åŠ ä½ç½®</text>
            <view class="tank-hint-text">
               æ­£åœ¨æ·»åŠ åˆ°: <text class="font-bold text-primary">{{currentTank.name}}</text>
            </view>
          </view>

          <!-- é±¼ç§ç±»é€‰æ‹© -->
          <view class="form-item">
            <text class="form-label">é±¼å“ç§ <text class="required">*</text></text>
            <picker 
                mode="multiSelector" 
                range="{{fishCategoryRange}}" 
                range-key="name" 
                value="{{fishCategoryIndex}}" 
                bindchange="onFishCategoryChange"
                bindcolumnchange="onFishCategoryColumnChange"
            >
              <view class="input-picker {{!fishForm.speciesId ? 'text-muted' : ''}}">
                <text>{{fishForm.speciesName || 'ç‚¹å‡»é€‰æ‹©åˆ†ç±»'}}</text>
                <text class="text-muted">></text>
              </view>
            </picker>
          </view>

          <!-- ä»·æ ¼ -->
          <view class="form-item">
            <text class="form-label">å•ä»· (Â¥) <text class="required">*</text></text>
            <input class="input" type="digit" placeholder="0.00" value="{{fishForm.price}}" bindinput="onFishPriceInput"></input>
          </view>
          
          <!-- æ•°é‡ -->
          <view class="form-item">
            <text class="form-label">æ•°é‡ (æ¡) <text class="required">*</text></text>
            <input class="input" type="number" placeholder="1" value="{{fishForm.count}}" maxlength="3" bindinput="onFishCountInput"></input>
          </view>

        </view>
      </scroll-view>

      <view class="popup__footer">
        <button class="btn btn--primary btn--block" bindtap="onSaveFish" loading="{{saving}}">ä¿å­˜è®°å½•</button>
      </view>
    </view>
  </view>
  <!-- ç¼–è¾‘é±¼ç±»å¼¹çª— -->
  <view wx:if="{{showFishEditPopup}}" class="popup-mask" bindtap="onCloseFishEditPopup">
    <view class="popup popup--bottom" catchtap="stopPropagation">
      <view class="popup__header">
        <text class="popup__close" bindtap="onCloseFishEditPopup">Ã—</text>
        <text class="popup__title">ç®¡ç†é±¼ç±»</text>
        <view class="popup__placeholder"></view>
      </view>

      <scroll-view class="popup__body" scroll-y enhanced show-scrollbar="{{false}}">
        <view class="form-wrapper">
          <!-- å¤´éƒ¨ä¿¡æ¯ -->
          <view class="fish-edit-header">
             <view class="fish-avatar large">ğŸŸ</view>
             <view class="fish-edit-info">
               <text class="fish-name large">{{editFishForm.name}}</text>
               <text class="text-muted text-sm">æ‰€å±: {{editFishForm.tankName || currentTank.name}}</text>
             </view>
          </view>

          <!-- çŠ¶æ€æ¦‚è§ˆ -->
          <view class="form-section">
            <text class="section-title">çŠ¶æ€ç»Ÿè®¡</text>
            <view class="stats-grid" style="margin: 0 -24rpx;">
               <view class="stat-item">
                 <text class="stat-value text-success">{{editFishForm.currentAlive}}</text>
                 <text class="stat-label">å½“å‰å­˜æ´»</text>
               </view>
               <view class="stat-item">
                 <text class="stat-value">{{editFishForm.baseQuantity}}</text>
                 <text class="stat-label">åˆå§‹æ•°é‡</text>
               </view>
            </view>
          </view>

          <!-- è®°å½•æ­»äº¡ -->
          <view class="form-item">
             <text class="form-label">æ–°å¢æ­»äº¡ (æ¡)</text>
             <input class="input" type="number" placeholder="0" value="{{editFishForm.deadCount}}" bindinput="onFishDeadInput"></input>
             <text class="text-muted text-xs mt-xs">è¾“å…¥æœ¬æ¬¡å‘ç°çš„æ­»äº¡æ•°é‡ï¼Œå°†è‡ªåŠ¨æ‰£å‡å­˜æ´»æ•°</text>
          </view>


          <!-- ç§»åŠ¨é±¼ç±» -->
          <view class="form-item pt-md dashed-border-top">
             <view class="flex items-center justify-between mb-sm">
                <text class="form-label mb-0">æ‰€åœ¨é±¼ç¼¸</text>
             </view>
             <picker mode="selector" range="{{tanks}}" range-key="name" value="{{targetTankIndex}}" bindchange="onTransferTankChange">
                 <view class="input-picker">
                    <text>{{tanks[targetTankIndex].name}}</text>
                    <text class="text-muted">></text>
                 </view>
             </picker>
             <text class="text-muted text-xs mt-xs" wx:if="{{tanks[targetTankIndex]._id !== editFishForm.tankId}}">
                 ä¿å­˜åå°†ç§»åŠ¨è‡³è¯¥é±¼ç¼¸
             </text>
          </view>
        </view>
      </scroll-view>

      <view class="popup__footer" style="display: flex; gap: 24rpx;">
        <button class="btn btn--outline" bindtap="onDeleteFish" style="flex: 1; border-color: #333; color: #333;">åˆ é™¤</button>
        <button class="btn btn--primary" bindtap="onSaveEditFish" loading="{{saving}}" style="flex: 1;">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- æ¢æ°´è®°å½•å¼¹çª— -->
  <view wx:if="{{showWaterChangePopup}}" class="popup-mask" bindtap="onCloseWaterChangePopup">
    <view class="popup popup--bottom" catchtap="stopPropagation">
      <view class="popup__header">
        <text class="popup__close" bindtap="onCloseWaterChangePopup">Ã—</text>
        <text class="popup__title">è®°å½•æ¢æ°´</text>
        <view class="popup__placeholder"></view>
      </view>

      <view class="popup__body">
        <view class="form-wrapper">
          <!-- æ—¥æœŸ -->
          <view class="form-item">
            <text class="form-label">æ—¥æœŸ</text>
            <picker mode="date" value="{{waterChangeForm.date}}" bindchange="onWaterChangeDateChange">
              <view class="input-picker">
                <text>{{waterChangeForm.date}}</text>
                <text class="text-muted">></text>
              </view>
            </picker>
          </view>

          <!-- æ¢æ°´æ¯”ä¾‹ -->
          <view class="form-item">
             <view class="water-percent-row mb-sm">
                <text class="form-label mb-0">æ¢æ°´é‡</text>
                <text class="water-percent-value text-primary font-bold">{{waterChangeForm.percent}}%</text>
             </view>
             <slider
                min="0"
                max="100"
                step="5"
                value="{{waterChangeForm.percent}}"
                activeColor="#3b82f6"
                block-size="24"
                bindchanging="onWaterChangePercentChange"
                bindchange="onWaterChangePercentChange"
             />
             <view class="flex justify-between text-xs text-muted mt-xs">
               <text>å°‘é‡</text>
               <text>å¤§é‡</text>
             </view>
          </view>
        </view>
      </view>

      <view class="popup__footer">
        <button class="btn btn--primary btn--block" bindtap="onSaveWaterChange" loading="{{saving}}">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- è®¾å¤‡ç®¡ç†å¼¹çª— -->
  <view wx:if="{{showEquipmentPopup}}" class="popup-mask" bindtap="onCloseEquipmentPopup">
    <view class="popup popup--bottom" catchtap="stopPropagation">
      <view class="popup__header">
        <text class="popup__close" bindtap="onCloseEquipmentPopup">Ã—</text>
        <text class="popup__title">æ·»åŠ è®¾å¤‡</text>
        <view class="popup__placeholder"></view>
      </view>

      <scroll-view class="popup__body" scroll-y enhanced show-scrollbar="{{false}}" style="max-height: 70vh;">
        <view class="form-wrapper">
          <!-- ç±»å‹é€‰æ‹© -->
          <view class="form-item">
            <text class="form-label">è®¾å¤‡ç±»å‹</text>
            <picker range="{{equipmentTypes}}" range-key="label" bindchange="onEquipmentTypeChange">
               <view class="input-picker">
                  <text>{{equipmentForm.typeLabel || 'è¯·é€‰æ‹©'}}</text>
                  <text class="text-muted">></text>
               </view>
            </picker>
          </view>

          <!-- åç§° -->
          <view class="form-item">
            <text class="form-label">è®¾å¤‡åç§° <text class="required">*</text></text>
            <input class="input" placeholder="ä¾‹å¦‚ï¼šä¼Šç½•åŠ çƒ­æ£’" value="{{equipmentForm.name}}" data-field="name" bindinput="onEquipmentInput"></input>
          </view>

          <!-- å“ç‰Œ -->
          <view class="form-item">
            <text class="form-label">å“ç‰Œ</text>
            <input class="input" placeholder="ä¾‹å¦‚ï¼šEHEIM" value="{{equipmentForm.brand}}" data-field="brand" bindinput="onEquipmentInput"></input>
          </view>

          <!-- å‹å· -->
          <view class="form-item">
            <text class="form-label">å‹å·</text>
            <input class="input" placeholder="ä¾‹å¦‚ï¼š300W" value="{{equipmentForm.model}}" data-field="model" bindinput="onEquipmentInput"></input>
          </view>

          <!-- ä»·æ ¼ -->
          <view class="form-item">
            <text class="form-label">ä»·æ ¼ (Â¥)</text>
            <input class="input" type="digit" placeholder="0.00" value="{{equipmentForm.price}}" data-field="price" bindinput="onEquipmentInput"></input>
          </view>
        </view>
      </scroll-view>

      <view class="popup__footer">
        <button class="btn btn--primary btn--block" bindtap="onSaveEquipment" loading="{{saving}}">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- æ°´è´¨è®°å½•å¼¹çª— -->
  <view wx:if="{{showWaterQualityPopup}}" class="popup-mask" bindtap="onCloseWaterQualityPopup">
    <view class="popup popup--bottom" catchtap="stopPropagation">
      <view class="popup__header">
        <text class="popup__close" bindtap="onCloseWaterQualityPopup">Ã—</text>
        <text class="popup__title">è®°å½•æ°´è´¨</text>
        <view class="popup__placeholder"></view>
      </view>

      <scroll-view class="popup__body" scroll-y enhanced show-scrollbar="{{false}}" style="max-height: 70vh;">
        <view class="form-wrapper">
          <!-- æ—¥æœŸ -->
          <view class="form-item">
            <text class="form-label">æ—¥æœŸ</text>
            <picker mode="date" value="{{waterQualityForm.date}}" bindchange="onWaterQualityDateChange">
              <view class="input-picker">
                <text>{{waterQualityForm.date}}</text>
                <text class="text-muted">></text>
              </view>
            </picker>
          </view>

          <view class="flex gap-md">
             <view class="form-item flex-1">
                <text class="form-label">pHå€¼</text>
                <input class="input" type="digit" placeholder="7.0" value="{{waterQualityForm.ph}}" data-field="ph" bindinput="onWaterQualityInput"></input>
             </view>
             <view class="form-item flex-1">
                <text class="form-label">æ¸©åº¦ (Â°C)</text>
                <input class="input" type="digit" placeholder="26.0" value="{{waterQualityForm.temperature}}" data-field="temperature" bindinput="onWaterQualityInput"></input>
             </view>
          </view>

          <view class="flex gap-md">
             <view class="form-item flex-1">
                <text class="form-label">æ°¨æ°® (mg/L)</text>
                <input class="input" type="digit" placeholder="0" value="{{waterQualityForm.ammonia}}" data-field="ammonia" bindinput="onWaterQualityInput"></input>
             </view>
             <view class="form-item flex-1">
                <text class="form-label">NO2 (mg/L)</text>
                <input class="input" type="digit" placeholder="0" value="{{waterQualityForm.nitrite}}" data-field="nitrite" bindinput="onWaterQualityInput"></input>
             </view>
          </view>

          <view class="form-item">
            <text class="form-label">NO3 (mg/L)</text>
            <input class="input" type="digit" placeholder="10" value="{{waterQualityForm.nitrate}}" data-field="nitrate" bindinput="onWaterQualityInput"></input>
          </view>

          <!-- å›¾ç‰‡ä¸Šä¼  -->
          <view class="form-item">
            <text class="form-label">è¯•çº¸æ‹ç…§ (é€‰å¡«)</text>
            <view class="image-picker" bindtap="onChooseQualityImage">
              <image wx:if="{{waterQualityForm.imageUrl}}" src="{{waterQualityForm.imageUrl}}" mode="aspectFill" class="image-picker__preview"></image>
              <view wx:else class="image-picker__placeholder">
                <text class="image-picker__icon">+</text>
              </view>
            </view>
          </view>

        </view>
      </scroll-view>

      <view class="popup__footer">
        <button class="btn btn--primary btn--block" bindtap="onSaveWaterQuality" loading="{{saving}}">ä¿å­˜</button>
      </view>
    </view>
  </view>
  <!-- ç»Ÿä¸€è®°å½•å¼¹çª— -->
  <view wx:if="{{showRecordPopup}}" class="popup-mask" bindtap="onCloseRecordPopup">
    <view class="popup popup--bottom" catchtap="stopPropagation">
      <view class="popup__header">
        <text class="popup__close" bindtap="onCloseRecordPopup">Ã—</text>
        <text class="popup__title">æ·»åŠ è®°å½•</text>
        <view class="popup__placeholder"></view>
      </view>

      <scroll-view class="popup__body" scroll-y enhanced show-scrollbar="{{false}}">
        <view class="form-wrapper">
           <!-- è®°å½•ç±»å‹é€‰æ‹© - 3ä¸ªé€‰é¡¹ -->
           <view class="form-item">
              <text class="form-label">è®°å½•ç±»å‹</text>
              <view class="tags-row">
                 <view class="tag-option {{recordType === 'feeding' ? 'active' : ''}}" bindtap="onRecordTypeChange" data-type="feeding">å–‚å…»</view>
                 <view class="tag-option {{recordType === 'water-change' ? 'active' : ''}}" bindtap="onRecordTypeChange" data-type="water-change">æ¢æ°´</view>
                 <view class="tag-option {{recordType === 'water-quality' ? 'active' : ''}}" bindtap="onRecordTypeChange" data-type="water-quality">æ°´è´¨</view>
              </view>
           </view>

           <!-- å–‚å…»è¡¨å• -->
           <block wx:if="{{recordType === 'feeding'}}">
              <view class="form-item">
                <text class="form-label">æ—¶é—´</text>
                <picker mode="time" value="{{feedingForm.time}}" bindchange="onFeedingTimeSelect">
                   <view class="input-picker">
                      <text>{{feedingForm.time}}</text>
                      <text class="text-muted">></text>
                   </view>
                </picker>
              </view>
              <view class="form-item">
                 <text class="form-label">é£Ÿç‰©ç±»å‹</text>
                 <picker range="{{foodTypeOptions}}" range-key="label" bindchange="onFoodTypeChange">
                    <view class="input-picker">
                       <text>{{feedingForm.foodTypeLabel}}</text>
                       <text class="text-muted">></text>
                    </view>
                 </picker>
              </view>
              <view class="form-item">
                 <text class="form-label">é£Ÿç‰©åç§° (é€‰å¡«)</text>
                 <input class="input" placeholder="ä¾‹å¦‚ï¼šä¸°å¹´è™¾" value="{{feedingForm.foodName}}" data-field="foodName" bindinput="onFeedingInput"></input>
              </view>
              <view class="form-item">
                 <text class="form-label">å–‚é£Ÿé‡ (é€‰å¡«)</text>
                 <input class="input" placeholder="é€‚é‡" value="{{feedingForm.amount}}" data-field="amount" bindinput="onFeedingInput"></input>
              </view>
           </block>

           <!-- æ¢æ°´è¡¨å• -->
           <block wx:if="{{recordType === 'water-change'}}">
              <view class="form-item">
                <text class="form-label">æ—¶é—´</text>
                <picker mode="time" value="{{waterChangeForm.time}}" bindchange="onWaterChangeTimeChange">
                  <view class="input-picker">
                    <text>{{waterChangeForm.time}}</text>
                    <text class="text-muted">></text>
                  </view>
                </picker>
              </view>
              <view class="form-item">
                 <view class="water-percent-row mb-sm">
                    <text class="form-label mb-0">æ¢æ°´é‡</text>
                    <text class="water-percent-value text-primary font-bold">{{waterChangeForm.percent}}%</text>
                 </view>
                 <slider
                    min="0"
                    max="100"
                    step="5"
                    value="{{waterChangeForm.percent}}"
                    activeColor="#3b82f6"
                    block-size="24"
                    bindchanging="onWaterChangePercentChanging"
                    bindchange="onWaterChangePercentChange"
                 />
                 <view class="flex justify-between text-xs text-muted mt-xs">
                   <text>å°‘é‡</text>
                   <text>å¤§é‡</text>
                 </view>
              </view>
           </block>

           <!-- æ°´è´¨è¡¨å• -->
           <block wx:if="{{recordType === 'water-quality'}}">
              <view class="form-item">
                <text class="form-label">æ—¶é—´</text>
                <picker mode="time" value="{{waterQualityForm.time}}" bindchange="onWaterQualityTimeChange">
                  <view class="input-picker">
                    <text>{{waterQualityForm.time}}</text>
                    <text class="text-muted">></text>
                  </view>
                </picker>
              </view>
              <view class="flex gap-md">
                 <view class="form-item flex-1">
                    <text class="form-label">pHå€¼</text>
                    <input class="input" type="digit" placeholder="7.0" value="{{waterQualityForm.ph}}" data-field="ph" bindinput="onWaterQualityInput"></input>
                 </view>
                 <view class="form-item flex-1">
                    <text class="form-label">æ¸©åº¦ (Â°C)</text>
                    <input class="input" type="digit" placeholder="26.0" value="{{waterQualityForm.temperature}}" data-field="temperature" bindinput="onWaterQualityInput"></input>
                 </view>
              </view>
              <view class="flex gap-md">
                 <view class="form-item flex-1">
                    <text class="form-label">æ°¨æ°® (mg/L)</text>
                    <input class="input" type="digit" placeholder="0" value="{{waterQualityForm.ammonia}}" data-field="ammonia" bindinput="onWaterQualityInput"></input>
                 </view>
                 <view class="form-item flex-1">
                    <text class="form-label">NO2 (mg/L)</text>
                    <input class="input" type="digit" placeholder="0" value="{{waterQualityForm.nitrite}}" data-field="nitrite" bindinput="onWaterQualityInput"></input>
                 </view>
              </view>
              <view class="form-item">
                <text class="form-label">NO3 (mg/L)</text>
                <input class="input" type="digit" placeholder="10" value="{{waterQualityForm.nitrate}}" data-field="nitrate" bindinput="onWaterQualityInput"></input>
              </view>
           </block>
        </view>
      </scroll-view>

      <view class="popup__footer">
        <button class="btn btn--primary btn--block" bindtap="onSaveRecord" loading="{{saving}}">ä¿å­˜</button>
      </view>
    </view>
  </view>
